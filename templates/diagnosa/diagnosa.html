<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>StayHealthy - Diagnosis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="/static/css/style.css" />
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark custom-navbar px-4">
    <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">
      <img src="/static/asset/img/pws.png" alt="StayHealthy" class="logo-img">
    </a>

    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto me-4 gap-4">
        <li class="nav-item">
          <a class="nav-link active" href="{{ url_for('index') }}">Home</a>
        </li>
      </ul>
    </div>

    <div class="dropdown">
      <a href="#" role="button" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser"
        data-bs-toggle="dropdown" aria-expanded="false">

        <img src="{{ url_for('static', filename=session.get('profile_pic') or 'asset/img/dummy-pic.png') }}"
          class="rounded-circle" width="40" height="40">
      </a>

      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUser">
        <li class="dropdown-header text-center">
          {{ session['username'] }}
        </li>

        <li>
          <a class="dropdown-item" href="{{ url_for('auth.profile_page') }}">
            Profile
          </a>
        </li>

        <li>
          <hr class="dropdown-divider">
        </li>

        <li>
          <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
            Logout
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="header-pink"></div>

  <div class="container my-4" id="app"></div>

  <footer>
    Copyright Â© 2026 StayHealthy. All rights reserved.<br />
    Terms of Use | Privacy Policy | Cookie Policy
  </footer>

  <script>
    const pertanyaan = {{ gejala | tojson }};
  </script>

  <script>
    let currentStep = 1;
    let jawaban = {};
    const app = document.getElementById("app");
    const PER_STEP = 5;
    const TOTAL_STEP = Math.ceil(pertanyaan.length / PER_STEP);

    function render() {
      app.innerHTML = "";

      let start = (currentStep - 1) * PER_STEP;
      let end = start + PER_STEP;

      app.innerHTML += `<h5>Step ${currentStep} dari ${TOTAL_STEP}</h5>`;

      for (let i = start; i < end && i < pertanyaan.length; i++) {
        let no = i + 1;
        let nilai = jawaban[no] ?? 0;
        let percent = nilai * 100;

        // Cek apakah gejala ini sedang dipilih (nilai > 0)
        let isActive = nilai > 0;

        app.innerHTML += `
    <div class="question-box">
      <p class="question-title">Pertanyaan ${no}</p>
      <p>${pertanyaan[i]["Nama Gejala"]}</p>

      <button class="btn ${isActive ? 'btn-secondary' : 'btn-answer'}" onclick="toggleGejala(${no})">
        ${isActive ? 'Batalkan' : 'Ya'}
      </button>

      <div id="range-${no}" class="mt-3 ${isActive ? "" : "d-none"}">
        <input type="range" 
          class="form-range custom-range" 
          min="0" max="1" step="0.1" 
          value="${nilai}"
          style="background: linear-gradient(to right,#0d6efd ${percent}%,#e0e0e0 ${percent}%)"
          oninput="updateRange(${no}, this)">
        <p>Tingkat Keyakinan: <span id="nilai-${no}">${nilai}</span></p>
      </div>
    </div>`;
      }


      app.innerHTML += `
      <div class="text-end mt-3">
        ${currentStep > 1 ? `<button class="btn btn-secondary me-2" onclick="prevStep()">Sebelumnya</button>` : ""}
        ${currentStep < TOTAL_STEP
          ? `<button class="btn btn-next" onclick="nextStep()">Selanjutnya</button>`
          : `<button class="btn btn-next" onclick="kirimDiagnosis()">Lihat Hasil</button>`
        }
      </div>`;
    }

    // Fungsi baru untuk menggantikan jawabYa dan jawabTidak
    function toggleGejala(no) {
      let currentVal = jawaban[no] ?? 0;

      if (currentVal > 0) {
        // Jika sudah aktif, matikan (sama seperti logika tombol Tidak)
        jawaban[no] = 0;
      } else {
        // Jika belum aktif, aktifkan dengan nilai default 0.1 (agar slider terlihat ada isi sedikit)
        // Atau bisa set 0.5 sesuai preferensi default keyakinan
        jawaban[no] = 0.1;
      }
      
      // Render ulang untuk memperbarui tampilan tombol (Ya <-> Batal) dan visibility slider
      render();
    }

    function updateRange(no, slider) {
      let percent = slider.value * 100;
      slider.style.background = `linear-gradient(to right,#0d6efd ${percent}%,#e0e0e0 ${percent}%)`;
      jawaban[no] = parseFloat(slider.value);
      document.getElementById(`nilai-${no}`).innerText = slider.value;
    }

    function nextStep() {
      currentStep++;
      render();
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    }

    function prevStep() {
      currentStep--;
      render();
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    }

    render();

    async function kirimDiagnosis() {
      // 1. Siapkan Data
      let payload = {};

      pertanyaan.forEach((item, index) => {
        let no = index + 1;
        let nilai = jawaban[no] ? parseFloat(jawaban[no]) : 0.0;
        let kode = item['Kode Gejala'] || item['Kode'] || `G${no}`; // Sesuaikan dengan key di DB/Excel
        payload[kode] = nilai;
      });

      try {
        // 2. Ambil Token JWT
        const token = localStorage.getItem('access_token');
        if (!token) {
          alert("Anda belum login. Silakan login terlebih dahulu.");
          window.location.href = "/templates/profile/profile.html";
          return;
        }

        // 3. Kirim ke Backend
        const response = await fetch('/api/diagnosis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error("Gagal memproses diagnosa.");
        }

        const resultData = await response.json();

        // 4. Simpan Hasil & Redirect
        localStorage.setItem('hasil_diagnosa', JSON.stringify(resultData));
        window.location.href = "/diagnosis/hasil";

      } catch (error) {
        console.error(error);
        alert("Terjadi kesalahan: " + error.message);
      }
    }
  </script>

</body>

</html>